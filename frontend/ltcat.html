<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>DataInsight SST ‚Äì LTCAT / Laudo T√©cnico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="assets/branding.css">

  <!-- Biblioteca para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>

<body>

<nav class="nav">
  <div class="wrap">
    <div class="logo">
      <img src="assets/datainsight.jpg" alt="Logo">
      <span>LTCAT ‚Äî Laudo T√©cnico de Condi√ß√µes Ambientais</span>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px;">
      <a class="btn secondary" href="dashboard.html">üè† Dashboard</a>
      <a class="btn secondary" href="pgr.html">üìù PGR / NR-01</a>
      <a class="btn secondary" href="pcmso.html">‚öïÔ∏è PCMSO / ASO</a>
      <a class="btn secondary" href="nr17.html">ü™ë NR-17</a>
      <a class="btn active" href="ltcat.html">üìÑ LTCAT</a>
      <button onclick="logout()" class="btn danger">Sair</button>
    </div>
  </div>
</nav>

<div class="container">

  <!-- FORMUL√ÅRIO LTCAT -->
  <div class="card">
    <h2>üìÑ Registro de Informa√ß√µes para LTCAT</h2>
    <p class="section-subtitle">
      Estruture as informa√ß√µes essenciais para elabora√ß√£o do LTCAT: agente nocivo, exposi√ß√£o e enquadramento previdenci√°rio.
    </p>

    <div class="form-grid mt-3">

      <label>Empresa
        <input type="text" id="empresa" placeholder="Ex: Metal√∫rgica Alfa LTDA">
      </label>

      <label>CNPJ
        <input type="text" id="cnpj" placeholder="00.000.000/0000-00">
      </label>

      <label>Setor
        <input type="text" id="setor" placeholder="Ex: Caldeiraria / Oficina / Escrit√≥rio">
      </label>

      <label>Fun√ß√£o
        <input type="text" id="funcao" placeholder="Ex: Soldador / Operador de Prensa">
      </label>

      <label>GHE (opcional)
        <input type="text" id="ghe" placeholder="Ex: GHE 01 ‚Äì Soldagem">
      </label>

      <label>Agente Nocivo
        <input type="text" id="agente" placeholder="Ex: Ru√≠do, Benzeno, Calor, S√≠lica...">
      </label>

      <label>Classifica√ß√£o do Agente
        <select id="classificacao">
          <option value="F√≠sico">F√≠sico</option>
          <option value="Qu√≠mico">Qu√≠mico</option>
          <option value="Biol√≥gico">Biol√≥gico</option>
          <option value="Misto">Misto</option>
        </select>
      </label>

      <label>Fonte Geradora
        <input type="text" id="fonte" placeholder="Ex: Prensa hidr√°ulica, forno, produto qu√≠mico...">
      </label>

      <label>Meio de Propaga√ß√£o
        <input type="text" id="meio" placeholder="Ex: Ar, contato direto, superf√≠cies...">
      </label>

      <label>Intensidade / Concentra√ß√£o
        <input type="text" id="intensidade" placeholder="Ex: 92 dB(A), 15 ppm, 28 ¬∫C IBUTG">
      </label>

      <label>Unidade
        <input type="text" id="unidade" placeholder="Ex: dB(A), ppm, ¬∫C, mg/m¬≥">
      </label>

      <label>Jornada di√°ria (h)
        <input type="number" id="jornada" min="0" step="0.25" placeholder="Ex: 8">
      </label>

      <label>Dias por semana
        <input type="number" id="diasSemana" min="1" max="7" placeholder="Ex: 5">
      </label>

      <label>Tempo de exposi√ß√£o (anos)
        <input type="number" id="tempoAnos" min="0" step="0.5" placeholder="Ex: 12">
      </label>

      <label>EPC / EPI eficaz?
        <select id="epiEficaz">
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
          <option value="Parcial">Parcial</option>
        </select>
      </label>

      <label>Enquadramento Previdenci√°rio
        <select id="enquadramento">
          <option value="Sem enquadramento">Sem enquadramento</option>
          <option value="Especial ‚Äì 15 anos">Especial ‚Äì 15 anos</option>
          <option value="Especial ‚Äì 20 anos">Especial ‚Äì 20 anos</option>
          <option value="Especial ‚Äì 25 anos">Especial ‚Äì 25 anos</option>
        </select>
      </label>

      <label>Data da Avalia√ß√£o / Medi√ß√£o
        <input type="date" id="data">
      </label>

      <label>Respons√°vel T√©cnico
        <input type="text" id="responsavel" placeholder="Nome / Registro profissional">
      </label>

      <label style="grid-column: 1 / -1;">Observa√ß√µes (opcional)
        <textarea id="observacoes" rows="3" placeholder="Descrever metodologia utilizada, normas t√©cnicas, condi√ß√µes at√≠picas, recomenda√ß√µes..."></textarea>
      </label>

    </div>

    <div class="actions-row">
      <button class="btn primary" onclick="salvarLTCAT()">üíæ Salvar Registro</button>
      <button class="btn secondary" onclick="limparLTCAT()">üßπ Limpar</button>
      <button class="btn secondary" onclick="imprimirUltimoLTCAT()">üñ®Ô∏è Imprimir √∫ltimo</button>
      <button class="btn secondary" onclick="exportarPDFUltimoLTCAT()">üìÑ Exportar PDF (√∫ltimo)</button>
    </div>
  </div>

  <!-- LISTA DE REGISTROS -->
  <div class="card">
    <h2>üìö Registros para LTCAT</h2>

    <div class="actions-row">
      <input
        type="text"
        id="filtroLTCAT"
        placeholder="Filtrar por empresa, setor, fun√ß√£o ou agente..."
        oninput="filtrarLTCAT()"
        style="flex:1; max-width:360px;"
      >
    </div>

    <table class="table" id="tabelaLTCAT">
      <thead>
        <tr>
          <th>Data</th>
          <th>Empresa</th>
          <th>Setor</th>
          <th>Fun√ß√£o</th>
          <th>Agente</th>
          <th>Classifica√ß√£o</th>
          <th>Enquadramento</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- √ÅREA OCULTA PARA RELAT√ìRIO PDF -->
  <div id="areaRelatorioLTCAT" style="display:none;">
    <div id="conteudoRelatorioLTCAT" style="padding:20px; font-family:system-ui;"></div>
  </div>

</div>

<script>
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// ===============================
// LTCAT ‚Äì Registros b√°sicos
// ===============================

document.addEventListener("DOMContentLoaded", () => {
    carregarLTCAT();
});

function salvarLTCAT() {
    const empresa      = document.getElementById("empresa").value.trim();
    const cnpj         = document.getElementById("cnpj").value.trim();
    const setor        = document.getElementById("setor").value.trim();
    const funcao       = document.getElementById("funcao").value.trim();
    const ghe          = document.getElementById("ghe").value.trim();
    const agente       = document.getElementById("agente").value.trim();
    const classificacao= document.getElementById("classificacao").value;
    const fonte        = document.getElementById("fonte").value.trim();
    const meio         = document.getElementById("meio").value.trim();
    const intensidade  = document.getElementById("intensidade").value.trim();
    const unidade      = document.getElementById("unidade").value.trim();
    const jornada      = document.getElementById("jornada").value;
    const diasSemana   = document.getElementById("diasSemana").value;
    const tempoAnos    = document.getElementById("tempoAnos").value;
    const epiEficaz    = document.getElementById("epiEficaz").value;
    const enquadramento= document.getElementById("enquadramento").value;
    const data         = document.getElementById("data").value;
    const responsavel  = document.getElementById("responsavel").value.trim();
    const observacoes  = document.getElementById("observacoes").value.trim();

    if (!empresa || !setor || !funcao || !agente) {
        alert("‚ö†Ô∏è Preencha pelo menos Empresa, Setor, Fun√ß√£o e Agente nocivo.");
        return;
    }

    const registro = {
        id: Date.now(),
        empresa,
        cnpj,
        setor,
        funcao,
        ghe,
        agente,
        classificacao,
        fonte,
        meio,
        intensidade,
        unidade,
        jornada,
        diasSemana,
        tempoAnos,
        epiEficaz,
        enquadramento,
        data,
        responsavel,
        observacoes
    };

    let lista = JSON.parse(localStorage.getItem("registrosLTCAT")) || [];
    lista.push(registro);
    localStorage.setItem("registrosLTCAT", JSON.stringify(lista));

    localStorage.setItem("ultimoLTCATId", String(registro.id));

    carregarLTCAT();
    limparLTCAT();

    alert("‚úÖ Registro LTCAT salvo com sucesso!");
}

function carregarLTCAT(listaFiltrada = null) {
    let lista = listaFiltrada;
    if (!lista) {
        lista = JSON.parse(localStorage.getItem("registrosLTCAT")) || [];
    }

    const tbody = document.querySelector("#tabelaLTCAT tbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    lista.forEach(item => {
        const linha = `
            <tr>
                <td>${item.data || ""}</td>
                <td>${item.empresa || ""}</td>
                <td>${item.setor || ""}</td>
                <td>${item.funcao || ""}</td>
                <td>${item.agente || ""}</td>
                <td>${item.classificacao || ""}</td>
                <td>${item.enquadramento || ""}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", linha);
    });
}

function limparLTCAT() {
    document.getElementById("empresa").value = "";
    document.getElementById("cnpj").value = "";
    document.getElementById("setor").value = "";
    document.getElementById("funcao").value = "";
    document.getElementById("ghe").value = "";
    document.getElementById("agente").value = "";
    document.getElementById("classificacao").value = "F√≠sico";
    document.getElementById("fonte").value = "";
    document.getElementById("meio").value = "";
    document.getElementById("intensidade").value = "";
    document.getElementById("unidade").value = "";
    document.getElementById("jornada").value = "";
    document.getElementById("diasSemana").value = "";
    document.getElementById("tempoAnos").value = "";
    document.getElementById("epiEficaz").value = "Sim";
    document.getElementById("enquadramento").value = "Sem enquadramento";
    document.getElementById("data").value = "";
    document.getElementById("responsavel").value = "";
    document.getElementById("observacoes").value = "";
}

function filtrarLTCAT() {
    const termo = document.getElementById("filtroLTCAT").value.trim().toLowerCase();
    let lista = JSON.parse(localStorage.getItem("registrosLTCAT")) || [];

    if (termo === "") {
        carregarLTCAT(lista);
        return;
    }

    const filtrada = lista.filter(item => {
        return (
            (item.empresa || "").toLowerCase().includes(termo) ||
            (item.setor || "").toLowerCase().includes(termo) ||
            (item.funcao || "").toLowerCase().includes(termo) ||
            (item.agente || "").toLowerCase().includes(termo)
        );
    });

    carregarLTCAT(filtrada);
}

function obterUltimoLTCAT() {
    let lista = JSON.parse(localStorage.getItem("registrosLTCAT")) || [];
    if (lista.length === 0) return null;

    const ultimoId = localStorage.getItem("ultimoLTCATId");
    if (ultimoId) {
        const achado = lista.find(r => String(r.id) === ultimoId);
        if (achado) return achado;
    }
    return lista[lista.length - 1];
}

function montarHTMLRelatorioLTCAT(r) {
    return `
      <div style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color:#111827;">
        <h1 style="font-size:20px; margin-bottom:4px;">Relat√≥rio Sint√©tico ‚Äì LTCAT</h1>
        <p style="font-size:13px; color:#6b7280; margin-bottom:18px;">
          Registro estruturado para suporte ao Laudo T√©cnico de Condi√ß√µes Ambientais do Trabalho.
        </p>

        <h2 style="font-size:16px; margin-bottom:6px;">1. Identifica√ß√£o</h2>
        <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:12px;">
          <tr>
            <td style="padding:4px 0;"><strong>Empresa:</strong> ${r.empresa || "-"}</td>
            <td style="padding:4px 0;"><strong>CNPJ:</strong> ${r.cnpj || "-"}</td>
          </tr>
          <tr>
            <td style="padding:4px 0;"><strong>Setor:</strong> ${r.setor || "-"}</td>
            <td style="padding:4px 0;"><strong>Fun√ß√£o:</strong> ${r.funcao || "-"}</td>
          </tr>
          <tr>
            <td style="padding:4px 0;"><strong>GHE:</strong> ${r.ghe || "-"}</td>
            <td style="padding:4px 0;"><strong>Data da avalia√ß√£o:</strong> ${r.data || "-"}</td>
          </tr>
        </table>

        <h2 style="font-size:16px; margin-bottom:6px;">2. Agente Nocivo e Exposi√ß√£o</h2>
        <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:12px;">
          <tr>
            <td style="padding:4px 0;"><strong>Agente nocivo:</strong> ${r.agente || "-"}</td>
            <td style="padding:4px 0;"><strong>Classifica√ß√£o:</strong> ${r.classificacao || "-"}</td>
          </tr>
          <tr>
            <td style="padding:4px 0;"><strong>Fonte geradora:</strong> ${r.fonte || "-"}</td>
            <td style="padding:4px 0;"><strong>Meio de propaga√ß√£o:</strong> ${r.meio || "-"}</td>
          </tr>
          <tr>
            <td style="padding:4px 0;"><strong>Intensidade / concentra√ß√£o:</strong> ${r.intensidade || "-"} ${r.unidade || ""}</td>
            <td style="padding:4px 0;"><strong>Jornada / dias semanais:</strong> ${r.jornada || "-"} h, ${r.diasSemana || "-"} dias/sem</td>
          </tr>
          <tr>
            <td style="padding:4px 0;"><strong>Tempo de exposi√ß√£o:</strong> ${r.tempoAnos || "-"} anos</td>
            <td style="padding:4px 0;"><strong>EPC / EPI eficaz:</strong> ${r.epiEficaz || "-"}</td>
          </tr>
        </table>

        <h2 style="font-size:16px; margin-bottom:6px;">3. Enquadramento Previdenci√°rio</h2>
        <p style="font-size:13px; margin-bottom:10px;">
          <strong>Situa√ß√£o:</strong> ${r.enquadramento || "Sem enquadramento definido."}
        </p>

        <h2 style="font-size:16px; margin-bottom:6px;">4. Observa√ß√µes</h2>
        <div style="font-size:13px; border:1px solid #e5e7eb; border-radius:8px; padding:10px; min-height:60px;">
          ${r.observacoes && r.observacoes.trim() !== "" ? r.observacoes : "Sem observa√ß√µes adicionais registradas."}
        </div>

        <h2 style="font-size:16px; margin-top:16px; margin-bottom:6px;">5. Respons√°vel T√©cnico</h2>
        <p style="font-size:13px; margin-bottom:4px;">
          <strong>Nome / Registro:</strong> ${r.responsavel || "-"}
        </p>

        <p style="font-size:11px; color:#9ca3af; margin-top:18px;">
          Este relat√≥rio sint√©tico n√£o substitui o LTCAT completo, mas organiza de forma padronizada as informa√ß√µes
          essenciais para sua elabora√ß√£o, em conformidade com a legisla√ß√£o previdenci√°ria e normas de SST.
        </p>
      </div>
    `;
}

function imprimirUltimoLTCAT() {
    const r = obterUltimoLTCAT();
    if (!r) {
        alert("‚ö†Ô∏è Ainda n√£o h√° registros LTCAT salvos.");
        return;
    }

    const html = montarHTMLRelatorioLTCAT(r);
    const win = window.open("", "_blank");
    win.document.write(`
      <!doctype html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Relat√≥rio LTCAT</title>
      </head>
      <body style="margin:20px;">${html}</body>
      </html>
    `);
    win.document.close();
    win.focus();
    win.print();
}

function exportarPDFUltimoLTCAT() {
    const r = obterUltimoLTCAT();
    if (!r) {
        alert("‚ö†Ô∏è Ainda n√£o h√° registros LTCAT salvos.");
        return;
    }

    const container = document.getElementById("conteudoRelatorioLTCAT");
    container.innerHTML = montarHTMLRelatorioLTCAT(r);

    const opt = {
        margin:       10,
        filename:     `LTCAT_${(r.empresa || "empresa").replace(/\s+/g,"_")}.pdf`,
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(container).set(opt).save();
}
</script>

</body>
</html>
