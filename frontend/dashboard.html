<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>DataInsight SST Suite ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="assets/branding.css">

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<nav class="nav">
  <div class="wrap">
    <div class="logo">
      <img src="assets/datainsight.jpg" alt="Logo">
      <span>DataInsight SST Suite</span>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px;">
      <a class="btn active" href="dashboard.html">üè† Dashboard</a>
      <a class="btn secondary" href="pgr.html">üìù PGR / NR-01</a>
      <a class="btn secondary" href="pcmso.html">‚öïÔ∏è PCMSO / ASO</a>
      <a class="btn secondary" href="nr17.html">ü™ë NR-17</a>
      <a class="btn secondary" href="ltcat.html">üìÑ LTCAT</a>
      <button class="btn danger" onclick="logout()">Sair</button>
    </div>
  </div>
</nav>

<div class="container">

  <!-- VIS√ÉO GERAL / KPIs -->
  <div class="card">
    <h2>üìä Vis√£o Geral da Su√≠te</h2>
    <p class="section-subtitle mt-1">
      Indicadores consolidados dos m√≥dulos PCMSO / ASO, NR-17 e LTCAT com base nos
      registros armazenados no navegador (localStorage).
    </p>
  </div>

  <div class="card-grid mt-3">
    <div class="card">
      <h3>Total de ASOs registrados</h3>
      <p class="kpi-number" id="kpiTotalASO">0</p>
      <p class="section-subtitle">Registros de exames ocupacionais armazenados.</p>
    </div>

    <div class="card">
      <h3>Total de avalia√ß√µes NR-17</h3>
      <p class="kpi-number" id="kpiTotalNR17">0</p>
      <p class="section-subtitle">Postos de trabalho avaliados ergonomicamente.</p>
    </div>

    <div class="card">
      <h3>Total de registros LTCAT</h3>
      <p class="kpi-number" id="kpiTotalLTCAT">0</p>
      <p class="section-subtitle">Registros de agentes nocivos / enquadramento.</p>
    </div>

    <div class="card">
      <h3>Risco m√©dio NR-17</h3>
      <p class="kpi-number" id="kpiRiscoNR17">‚Äì</p>
      <p class="section-subtitle">Classifica√ß√£o global considerando todas as avalia√ß√µes.</p>
    </div>
  </div>

  <!-- GR√ÅFICOS -->
  <div class="card-grid mt-3">
    <div class="card">
      <h3>Distribui√ß√£o de Registros por M√≥dulo</h3>
      <canvas id="chartModulos" height="200"></canvas>
      <p class="section-subtitle mt-2">
        Quantidade de registros nos m√≥dulos ASO, NR-17 e LTCAT.
      </p>
    </div>

    <div class="card">
      <h3>Perfil de Risco ‚Äî NR-17</h3>
      <canvas id="chartNR17Risco" height="200"></canvas>
      <p class="section-subtitle mt-2">
        Quantidade de avalia√ß√µes classificadas como Baixo, M√©dio e Alto risco.
      </p>
    </div>
  </div>

  <div class="card-grid mt-3">
    <div class="card">
      <h3>Agentes nocivos mais registrados ‚Äî LTCAT</h3>
      <canvas id="chartAgentesLTCAT" height="200"></canvas>
      <p class="section-subtitle mt-2">
        Top 5 agentes com maior n√∫mero de ocorr√™ncias nos registros LTCAT.
      </p>
    </div>

    <div class="card">
      <h3>√öltimas atividades</h3>
      <p class="section-subtitle">
        Registros recentes em NR-17 e LTCAT (ordenados por data).
      </p>
      <ul id="listaAtividades" class="mt-2" style="list-style:none; padding-left:0; font-size:0.9rem;">
        <!-- preenchido via JS -->
      </ul>
    </div>
  </div>

</div>

<script>
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// ===============================
// Fun√ß√µes utilit√°rias
// ===============================
function getArrayFromLocalStorage(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch (e) {
    return [];
  }
}

// tentativa de descobrir ASO em diferentes chaves
function getASORegistros() {
  const possibleKeys = ["registrosASO", "asosRegistrados", "registrosPCMSO"];
  for (const key of possibleKeys) {
    const arr = getArrayFromLocalStorage(key);
    if (arr.length > 0) return arr;
  }
  // se nada encontrado, devolve array vazio
  return [];
}

// ===============================
// Carregamento do Dashboard
// ===============================
document.addEventListener("DOMContentLoaded", () => {
  const registrosASO   = getASORegistros();
  const avaliacoesNR17 = getArrayFromLocalStorage("avaliacoesNR17");
  const registrosLTCAT = getArrayFromLocalStorage("registrosLTCAT");

  // ----- KPIs -----
  document.getElementById("kpiTotalASO").textContent    = registrosASO.length;
  document.getElementById("kpiTotalNR17").textContent   = avaliacoesNR17.length;
  document.getElementById("kpiTotalLTCAT").textContent  = registrosLTCAT.length;

  // risco m√©dio NR-17
  if (avaliacoesNR17.length > 0) {
    let somaScore = 0;
    let baixo = 0, medio = 0, alto = 0;

    avaliacoesNR17.forEach(a => {
      const score = Number(a.score) || 0;
      somaScore += score;

      const risco = (a.risco || "").toLowerCase();
      if (risco === "baixo") baixo++;
      else if (risco === "m√©dio" || risco === "medio") medio++;
      else if (risco === "alto") alto++;
    });

    const media = somaScore / avaliacoesNR17.length;
    let classificacao = "Baixo";
    if (media >= 9 && media <= 12) classificacao = "M√©dio";
    else if (media > 12) classificacao = "Alto";

    const texto = `${classificacao} (score m√©dio: ${media.toFixed(1)})`;
    const kpi = document.getElementById("kpiRiscoNR17");
    kpi.textContent = texto;
  } else {
    document.getElementById("kpiRiscoNR17").textContent = "Sem dados";
  }

  // ----- Gr√°fico 1: Registros por m√≥dulo -----
  const ctxMod = document.getElementById("chartModulos");
  if (ctxMod && window.Chart) {
    new Chart(ctxMod, {
      type: "bar",
      data: {
        labels: ["ASO", "NR-17", "LTCAT"],
        datasets: [{
          label: "Quantidade de registros",
          data: [registrosASO.length, avaliacoesNR17.length, registrosLTCAT.length]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { precision:0 } }
        }
      }
    });
  }

  // ----- Gr√°fico 2: Perfil de risco NR-17 -----
  const ctxRisco = document.getElementById("chartNR17Risco");
  if (ctxRisco && window.Chart) {
    let baixo = 0, medio = 0, alto = 0;
    avaliacoesNR17.forEach(a => {
      const risco = (a.risco || "").toLowerCase();
      if (risco === "baixo") baixo++;
      else if (risco === "m√©dio" || risco === "medio") medio++;
      else if (risco === "alto") alto++;
    });

    new Chart(ctxRisco, {
      type: "doughnut",
      data: {
        labels: ["Baixo", "M√©dio", "Alto"],
        datasets: [{
          label: "Qtd. avalia√ß√µes",
          data: [baixo, medio, alto]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // ----- Gr√°fico 3: Agentes mais registrados no LTCAT -----
  const ctxAgentes = document.getElementById("chartAgentesLTCAT");
  if (ctxAgentes && window.Chart) {
    const freq = {};
    registrosLTCAT.forEach(r => {
      const ag = (r.agente || "N√£o informado").trim();
      if (!freq[ag]) freq[ag] = 0;
      freq[ag]++;
    });

    const agentes = Object.keys(freq);
    agentes.sort((a,b) => freq[b] - freq[a]);
    const topAgentes = agentes.slice(0,5);
    const valores = topAgentes.map(a => freq[a]);

    new Chart(ctxAgentes, {
      type: "bar",
      data: {
        labels: topAgentes,
        datasets: [{
          label: "Ocorr√™ncias",
          data: valores
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { precision:0 } }
        }
      }
    });
  }

  // ----- √öltimas atividades (NR-17 + LTCAT) -----
  const atividades = [];

  avaliacoesNR17.forEach(a => {
    atividades.push({
      data: a.dataAvaliacao || "",
      tipo: "NR-17",
      resumo: `${a.setor || "-"} / ${a.funcao || "-"}`,
      detalhe: `Risco ${a.risco || "-"} (score ${a.score || "-"})`
    });
  });

  registrosLTCAT.forEach(r => {
    atividades.push({
      data: r.data || "",
      tipo: "LTCAT",
      resumo: `${r.setor || "-"} / ${r.funcao || "-"}`,
      detalhe: `Agente: ${r.agente || "-"} | Enq.: ${r.enquadramento || "-"}`
    });
  });

  // ordenar por data (desc) ‚Äì datas no formato AAAA-MM-DD funcionam bem
  atividades.sort((a, b) => {
    const da = a.data || "";
    const db = b.data || "";
    if (da < db) return 1;
    if (da > db) return -1;
    return 0;
  });

  const ultimas = atividades.slice(0, 6);
  const lista = document.getElementById("listaAtividades");
  if (lista) {
    lista.innerHTML = "";
    if (ultimas.length === 0) {
      lista.innerHTML = "<li>Nenhuma atividade registrada ainda.</li>";
    } else {
      ultimas.forEach(item => {
        const li = document.createElement("li");
        li.style.marginBottom = "8px";
        li.innerHTML = `
          <strong>${item.tipo}</strong> ‚Äî ${item.data || "sem data"}<br>
          <span>${item.resumo}</span><br>
          <span style="color:#6b7280;">${item.detalhe}</span>
        `;
        lista.appendChild(li);
      });
    }
  }
});
</script>

</body>
</html>
